# Maintainer:  Dave Murphy <davem@devkitpro.org>
# Contributor: Nathan Rajlich <n@n8.io>

pkgbasename=wasm3
pkgname=switch-$pkgbasename
pkgver=0.5.0
pkgrel=2
pkgdesc='A fast WebAssembly interpreter and the most universal WASM runtime.'
arch=('any')
url='https://github.com/wasm3/wasm3/'
license=('MIT')
options=(!strip libtool staticlibs)
source=(
    "https://github.com/wasm3/wasm3/archive/772f8f4648fcba75f77f894a6050db121e7651a2.tar.gz"
    # v0.5.0 is missing some fixes / improvements compared to HEAD
    #"https://github.com/wasm3/wasm3/archive/refs/tags/v${pkgver}.tar.gz"
)
sha256sums=(
    '919e8ed733cfabba30c3d9480e65db502301e010985752ef7a64c7b59619667a'
)
makedepends=('dkp-toolchain-vars' 'switch-cmake')
groups=('switch-portlibs')
build() {
    cd ${pkgbasename}-*

    source /opt/devkitpro/switchvars.sh

    aarch64-none-elf-cmake \
        -G"Unix Makefiles" \
        -DCMAKE_INSTALL_PREFIX=$PORTLIBS_PREFIX \
        -DBUILD_NATIVE=OFF \
        -DBUILD_WASI=OFF \
        -DBUILD_SHARED_LIBS=OFF \
        -DCMAKE_BUILD_TYPE=Release \
        .

    make V=1
}

package() {
    cd ${pkgbasename}-*

    #DESTDIR="$pkgdir" cmake -P cmake_install.cmake
    # ... or ...
    #DESTDIR="$pkgdir" cmake --install .

    # Can't figure out how to make the above work,
    # so just copy the files manually
    mkdir -p "$pkgdir"${PORTLIBS_PREFIX}/include
    mkdir -p "$pkgdir"${PORTLIBS_PREFIX}/lib
    cp -v source/*.h "$pkgdir"${PORTLIBS_PREFIX}/include
    cp -v source/*.a "$pkgdir"${PORTLIBS_PREFIX}/lib
}
