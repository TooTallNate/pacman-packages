# Maintainer:  Dave Murphy <davem@devkitpro.org>
# Contributor: TooTallNate <n@n8.io>

pkgname=switch-quickjs
pkgver=2021.03.27
pkgrel=1
pkgdesc='QuickJS is a small and embeddable Javascript engine. It supports the ES2020 specification including modules, asynchronous generators, proxies and BigInt.'
arch=('any')
url='https://bellard.org/quickjs/'
license=(MIT)
options=(!strip libtool staticlibs)
depends=()
groups=('switch-portlibs')
makedepends=('switch-pkg-config' 'dkp-toolchain-vars')
source=("https://github.com/TooTallNate/quickjs/archive/8add8ffc6efbb2128a0e81a7a5652d352e7fec7b.tar.gz")
sha256sums=(
    '3ee21de50b93022ae22513d63374e66156a0c36668c46575d05d300fdbf93302'
)

build() {
    cd quickjs-*

    source /opt/devkitpro/switchvars.sh

    make ARMCPU=cortex-a57 ARMLINUX=yes CROSS_PREFIX=aarch64-none-elf- CFLAGS="-march=armv8-a+crc+crypto -mtune=cortex-a57 -fPIE -I/opt/devkitpro/devkitA64/aarch64-none-elf/include -DCONFIG_BIGNUM" LDFLAGS="-L/opt/devkitpro/devkitA64/aarch64-none-elf/lib" libquickjs.a
}

package() {
    cd quickjs-*

    source /opt/devkitpro/switchvars.sh

    mkdir -p "$pkgdir/$PORTLIBS_PREFIX/lib" "$pkgdir/$PORTLIBS_PREFIX/include/quickjs"
    install -m644 libquickjs.a "$pkgdir/$PORTLIBS_PREFIX/lib"
    #install -m644 libquickjs.lto.a "$pkgdir/$PORTLIBS_PREFIX/lib/quickjs"
    install -m644 quickjs.h quickjs-libc.h "$pkgdir/$PORTLIBS_PREFIX/include/quickjs"
}
